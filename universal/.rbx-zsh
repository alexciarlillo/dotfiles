RBLX_NAME=aciarlillo
local rbx_base_dir="$HOME/GitHub/roblox"

# Roblox WebApps specific locations
RBLX_WEB_APPS_DIR="$HOME/GitHub/roblox/web-frontend/project/WebApps"
RBLX_WEB_APPS_JEST_CONFIG="$RBLX_WEB_APPS_DIR/Roblox.App.Configuration/jest/jest-test.config.js"

rpr() {
    BRANCH_SUFFIX=$(git branch --show-current | sed "s/$RBLX_NAME\///")
    
    # Determine prefix (ADHOC or JIRA issue) and extract branch description
    if [[ "$BRANCH_SUFFIX" == ADHOC-* ]]; then
        PREFIX="ADHOC"
        BRANCH_DESC=$(echo "$BRANCH_SUFFIX" | sed 's/ADHOC-//')
    elif [[ "$BRANCH_SUFFIX" == [A-Z]*-[0-9]* ]]; then
        PREFIX=$(echo "$BRANCH_SUFFIX" | sed -E 's/^([A-Z]+-[0-9]+)(-.*)?$/\1/')
        BRANCH_DESC=$(echo "$BRANCH_SUFFIX" | sed -E 's/^[A-Z]+-[0-9]+-(.+)$/\1/' | grep -v '^[A-Z]')
    else
        echo "Error: Branch name doesn't match expected format"
        return 1
    fi
    
    # Unified logic to determine title description
    if [ -n "$1" ]; then
        # 1. Argument provided - use it
        DESCRIPTION="$1"
    elif [ -n "$BRANCH_DESC" ]; then
        # 2. Extract from branch name
        DESCRIPTION=$(echo "$BRANCH_DESC" | tr '-' ' ')
    else
        # 3. Fall back to first commit message
        DESCRIPTION=$(git log origin/main..HEAD --format=%s | tail -1)
    fi
    
    TITLE="$PREFIX: $DESCRIPTION"
    gh pr create --title "$TITLE" -T pull_request_template.md -w
}

rnb() {
    git checkout -b "$RBLX_NAME/$1" "$2"
}

get_main_branch() {
  if git show-ref --verify --quiet refs/heads/master; then
      echo "master"
  elif git show-ref --verify --quiet refs/heads/main; then
      echo "main"
  else
      echo "No master or main branch found."
      return 1
  fi
}

update_main_branch() {
  local target_branch=""

  target_branch=$(get_main_branch) || return 1

  echo "Updating $target_branch to match origin/$target_branch..."

  # Find the worktree where master/main is checked out
  local master_worktree=$(git worktree list --porcelain | grep "branch refs/heads/$target_branch" -B 2 | head -1 | cut -d' ' -f2)
  
  if [ -z "$master_worktree" ]; then
    echo "No worktree found with $target_branch checked out."
    return 1
  fi

  local original_dir=$(pwd)
  cd "$master_worktree" || return 1

  git fetch origin "$target_branch" && git checkout "$target_branch" && git reset --hard "origin/$target_branch" && cd "$original_dir"
}

rpb() {
  local target_branch=""

  target_branch=$(get_main_branch) || return 1

  # Update master worktree to exactly match origin
  update_main_branch || return 1
  
  # Create new branch from updated master
  rnb "$1" "$target_branch"
}

rpull() {
  local current_branch=$(git rev-parse --abbrev-ref HEAD)
  local upstream_primary_branch=$(get_main_branch) || return 1

  update_main_branch || return 1

  if [ "$current_branch" = "$upstream_primary_branch" ]; then
      git pull --tags
  else
      git pull --tags --rebase origin "$upstream_primary_branch"
  fi
}


# Change directory to any roblox repo with completions
rbx() {
    # If no argument, go to base directory
    if [ -z "$1" ]; then
        cd "$rbx_base_dir"
        return
    fi
 
    
    local target_dir="$rbx_base_dir/$1"
    
    # Check if directory exists
    if [ ! -d "$target_dir" ]; then
        echo "Directory not found: $target_dir"
        return 1
    fi
    
    # Take a second argument to a git worktree path if provided
    if [ -n "$2" ]; then
        worktree_dir="$target_dir/worktrees/$2"

        # Change to the target directory if it exists
        if [ -d "$worktree_dir" ]; then
            cd "$worktree_dir"
            return
        else
            echo "Worktree not found: $worktree_dir, defaulting to main repo."
        fi
    fi

    # If master subdirectory exists, go there, if main exists go there otherwise go to the root
    if [ -d "$target_dir/master" ]; then
        cd "$target_dir/master"
    elif [ -d "$target_dir/main" ]; then
        cd "$target_dir/main"
    else
        cd "$target_dir"
    fi
}

# Completion function
_rbx() {
    local -a subdirs
    
    # Get all subdirectories (only directories, not files)
    subdirs=(${rbx_base_dir}/*(/N:t))
    
    _describe 'roblox repositories' subdirs
}

# Register the completion
compdef _rbx rbx

# This will run jest from the top level WebApps directory, but
# convert any relative paths to absolute paths based on the current directory 
# so that tests can be run from any directory.
rbx-jest() {
    local current_dir="$(pwd)"
    local -a abs_args

    # Convert relative paths to absolute
    for arg in "$@"; do
        # If it's a flag (starts with -), keep as-is
        if [[ "$arg" =~ ^- ]]; then
            abs_args+=("$arg")
        # If already absolute, keep as-is
        elif [[ "$arg" = /* ]]; then
            abs_args+=("$arg")
        # Otherwise, make it absolute from current directory
        else
            abs_args+=("$current_dir/$arg")
        fi
    done

    (cd "$RBLX_WEB_APPS_DIR" && npm run jest-test "${abs_args[@]}") 
}

rbx-jest-dev() {
    local current_dir="$(pwd)"
    local -a abs_args

    # Convert relative paths to absolute
    for arg in "$@"; do
        # If it's a flag (starts with -), keep as-is
        if [[ "$arg" =~ ^- ]]; then
            abs_args+=("$arg")
        # If already absolute, keep as-is
        elif [[ "$arg" = /* ]]; then
            abs_args+=("$arg")
        # Otherwise, make it absolute from current directory
        else
            abs_args+=("$current_dir/$arg")
        fi
    done

 # if jest-dev.config.js exists in the current directory, use that instead of the default
    if [ -f "$current_dir/jest-dev.config.js" ]; then
        abs_args+=("--config" "$current_dir/jest-dev.config.js")
    else
        echo "No jest-dev.config.js found in current directory, using default."
    fi  

    (cd "$RBLX_WEB_APPS_DIR" && npx jest "${abs_args[@]}") 
}

# This will run eslint from the WebApps directory with the proper config and use 
# the correct node version and run the version of eslint installed in WebApps.
rbx-lint() {
    nvm use 14
    npx --prefix "$RBLX_WEB_APPS_DIR" eslint -c "$RBLX_WEB_APPS_DIR/.eslintrc.js" "$@"
}

